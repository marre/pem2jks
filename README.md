# pem2jks

A pure Go utility to convert PEM certificates (like those generated by Kubernetes cert-manager) into Java KeyStore (JKS) or PKCS#12 format.

## Features

- Converts PEM certificates and private keys to JKS or PKCS#12 format
- Supports RSA and EC private keys
- Handles certificate chains
- Can create keystores (with private key) or truststores (CA certs only)
- PKCS#12 legacy mode for compatibility with older Java versions
- Zero runtime dependencies - statically compiled
- Tiny container image (scratch base)
- Designed for Kubernetes sidecar/init container use

## Project Structure

```
.
├── cmd/
│   └── pem2jks/          # CLI application
│       └── main.go
├── pkg/
│   └── keystore/         # Keystore library
│       ├── keystore.go
│       └── keystore_test.go
├── scripts/
│   ├── generate-certs.sh # Generate test certificates
│   └── integration-test.sh
├── testdata/
│   └── VerifyKeystore.java
├── Dockerfile
├── Makefile
└── README.md
```

## Installation

### From source

```bash
go install github.com/marre/gojks/cmd/pem2jks@latest
```

### Build from source

```bash
git clone https://github.com/marre/gojks.git
cd gojks
make build
# Binary is created in bin/pem2jks
```

### Docker

```bash
docker pull ghcr.io/marre/pem2jks:latest
```

## Usage

```bash
# Create JKS keystore (default format)
pem2jks -c tls.crt -k tls.key -p changeit -o keystore.jks

# Create PKCS#12 keystore
pem2jks -c tls.crt -k tls.key -p changeit -o keystore.p12 -f pkcs12

# Create PKCS#12 with legacy algorithms (for older Java versions)
pem2jks -c tls.crt -k tls.key -p changeit -f pkcs12 --legacy

# Create keystore with certificate chain and CA
pem2jks -c tls.crt -k tls.key --ca ca.crt -p changeit

# Create truststore (CA certs only, no private key)
pem2jks --ca ca.crt -p changeit -o truststore.jks

# Use environment variable for password
export KEYSTORE_PASSWORD=changeit
pem2jks -c tls.crt -k tls.key

# Show version
pem2jks version

# Show help
pem2jks --help
```

### Options

| Option | Short | Description |
|--------|-------|-------------|
| `--cert` | `-c` | Path to certificate PEM file |
| `--key` | `-k` | Path to private key PEM file (optional) |
| `--ca` | | Path to CA certificate PEM file (optional) |
| `--output` | `-o` | Output keystore file path (default based on format) |
| `--password` | `-p` | Keystore password |
| `--password-file` | | File containing keystore password |
| `--alias` | `-a` | Alias for the private key entry (default: server) |
| `--format` | `-f` | Output format: `jks` or `pkcs12` (default: jks) |
| `--legacy` | | Use legacy PKCS#12 algorithms (for older Java) |
| `--help` | `-h` | Show help |

### Commands

| Command | Description |
|---------|-------------|
| `version` | Show version information |

### Environment Variables

| Variable | Description |
|----------|-------------|
| `KEYSTORE_PASSWORD` | Keystore password (lowest priority) |

### Output Formats

| Format | Description | Use Case |
|--------|-------------|----------|
| `jks` | Java KeyStore | Traditional Java applications |
| `pkcs12` | PKCS#12 (modern) | Modern applications, cross-platform |
| `pkcs12 --legacy` | PKCS#12 (legacy) | Older Java (< 8u301), legacy systems |

## Kubernetes Usage

### As an Init Container

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: java-app
spec:
  initContainers:
  - name: cert-converter
    image: ghcr.io/marre/pem2jks:latest
    args:
      - --cert=/certs/tls.crt
      - --key=/certs/tls.key
      - --ca=/certs/ca.crt
      - --alias=myapp
      - --password-file=/secrets/keystore-password
      - --output=/keystore/keystore.p12
      - --format=pkcs12
    volumeMounts:
    - name: certs
      mountPath: /certs
      readOnly: true
    - name: keystore
      mountPath: /keystore
    - name: secrets
      mountPath: /secrets
      readOnly: true
  containers:
  - name: java-app
    image: my-java-app:latest
    env:
    - name: JAVA_OPTS
      value: "-Djavax.net.ssl.keyStore=/keystore/keystore.jks -Djavax.net.ssl.keyStorePassword=changeit"
    volumeMounts:
    - name: keystore
      mountPath: /keystore
      readOnly: true
  volumes:
  - name: certs
    secret:
      secretName: my-tls-cert  # Created by cert-manager
  - name: keystore
    emptyDir: {}
  - name: secrets
    secret:
      secretName: keystore-password
```

### With cert-manager Certificate

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: my-tls-cert
spec:
  secretName: my-tls-cert
  issuerRef:
    name: my-issuer
    kind: ClusterIssuer
  commonName: myapp.example.com
  dnsNames:
  - myapp.example.com
```

## Input Formats

### Certificate (tls.crt)

PEM-encoded X.509 certificate. May contain certificate chain:

```
-----BEGIN CERTIFICATE-----
MIIDg...
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIDf... (intermediate CA)
-----END CERTIFICATE-----
```

### Private Key (tls.key)

PEM-encoded private key. Supports:
- PKCS#8 (`-----BEGIN PRIVATE KEY-----`)
- PKCS#1 RSA (`-----BEGIN RSA PRIVATE KEY-----`)
- SEC1 EC (`-----BEGIN EC PRIVATE KEY-----`)

### CA Certificate (ca.crt)

PEM-encoded CA certificate(s):

```
-----BEGIN CERTIFICATE-----
MIIDh... (CA cert)
-----END CERTIFICATE-----
```

## Development

```bash
# Run all checks and build
make all

# Build the binary
make build

# Run unit tests
make test

# Run integration tests (requires Java)
make test-integration

# Format and lint code
make lint

# Build Docker image
make docker

# Clean build artifacts
make clean

# Show all available targets
make help
```

## Using as a Library

The `pkg/keystore` package can be used as a Go library:

```go
import "github.com/marre/gojks/pkg/keystore"

// Create JKS from PEM data
jksData, err := keystore.CreateJKSFromPEM(certPEM, keyPEM, caPEM, "changeit", "server")

// Create PKCS#12 from PEM data
p12Data, err := keystore.CreatePKCS12FromPEM(certPEM, keyPEM, caPEM, "changeit")

// Create legacy PKCS#12 for older Java versions
p12Data, err := keystore.CreatePKCS12FromPEMLegacy(certPEM, keyPEM, caPEM, "changeit")
```

## License

MIT License
